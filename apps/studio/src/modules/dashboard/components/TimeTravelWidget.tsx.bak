import React, { useState, useEffect, useCallback } from 'react';
import { DatePicker, Button, Space, Slider, theme, Tooltip, Alert } from 'antd';
import {
  HistoryOutlined,
  PlayCircleOutlined,
  PauseCircleOutlined,
  StepBackwardOutlined,
  StepForwardOutlined,
  ReloadOutlined,
  ClockCircleOutlined,
} from '@ant-design/icons';
import dayjs, { Dayjs } from 'dayjs';
import { UIText } from '@kb-labs/studio-ui-kit';

const { useToken } = theme;

interface TimeTravelState {
  isActive: boolean;
  selectedTime: Dayjs | null;
  isPlaying: boolean;
  playbackSpeed: number;
}

interface HistoricalSnapshot {
  timestamp: number;
  metrics: {
    requests: number;
    errors: number;
    latency: number;
    cost: number;
  };
}

// Generate mock historical data
const generateMockHistory = (startTime: Dayjs, endTime: Dayjs): HistoricalSnapshot[] => {
  const snapshots: HistoricalSnapshot[] = [];
  let current = startTime;

  while (current.isBefore(endTime)) {
    const hourOfDay = current.hour();
    const isBusinessHours = hourOfDay >= 9 && hourOfDay <= 17;
    const baseMultiplier = isBusinessHours ? 1.5 : 0.7;

    snapshots.push({
      timestamp: current.valueOf(),
      metrics: {
        requests: Math.floor((500 + Math.random() * 300) * baseMultiplier),
        errors: Math.floor(Math.random() * 15 * baseMultiplier),
        latency: Math.floor((80 + Math.random() * 100) * baseMultiplier),
        cost: parseFloat(((0.5 + Math.random() * 0.3) * baseMultiplier).toFixed(4)),
      },
    });

    current = current.add(5, 'minute');
  }

  return snapshots;
};

export function TimeTravelWidget() {
  const { token } = useToken();
  const [state, setState] = useState<TimeTravelState>({
    isActive: false,
    selectedTime: null,
    isPlaying: false,
    playbackSpeed: 1,
  });

  const [historicalData, setHistoricalData] = useState<HistoricalSnapshot[]>([]);
  const [currentSnapshot, setCurrentSnapshot] = useState<HistoricalSnapshot | null>(null);

  // Load historical data when date is selected
  const handleDateChange = (date: Dayjs | null) => {
    if (date) {
      const startOfDay = date.startOf('day');
      const endOfDay = date.endOf('day');
      const data = generateMockHistory(startOfDay, dayjs().isBefore(endOfDay) ? dayjs() : endOfDay);
      setHistoricalData(data);
      setState(prev => ({
        ...prev,
        isActive: true,
        selectedTime: data.length > 0 ? dayjs(data[0].timestamp) : startOfDay,
        isPlaying: false,
      }));
    }
  };

  // Find snapshot for current time
  useEffect(() => {
    if (state.selectedTime && historicalData.length > 0) {
      const targetTs = state.selectedTime.valueOf();
      const snapshot = historicalData.reduce((closest, current) => {
        const closestDiff = Math.abs(closest.timestamp - targetTs);
        const currentDiff = Math.abs(current.timestamp - targetTs);
        return currentDiff < closestDiff ? current : closest;
      });
      setCurrentSnapshot(snapshot);
    }
  }, [state.selectedTime, historicalData]);

  // Playback logic
  useEffect(() => {
    if (state.isPlaying && state.selectedTime && historicalData.length > 0) {
      const interval = setInterval(() => {
        setState(prev => {
          if (!prev.selectedTime) return prev;

          const currentIndex = historicalData.findIndex(
            s => s.timestamp >= prev.selectedTime!.valueOf()
          );
          const nextIndex = currentIndex + 1;

          if (nextIndex >= historicalData.length) {
            return { ...prev, isPlaying: false };
          }

          return {
            ...prev,
            selectedTime: dayjs(historicalData[nextIndex].timestamp),
          };
        });
      }, 1000 / state.playbackSpeed);

      return () => clearInterval(interval);
    }
  }, [state.isPlaying, state.playbackSpeed, historicalData]);

  const togglePlayback = () => {
    setState(prev => ({ ...prev, isPlaying: !prev.isPlaying }));
  };

  const stepBackward = () => {
    if (!state.selectedTime || historicalData.length === 0) return;

    const currentIndex = historicalData.findIndex(
      s => s.timestamp >= state.selectedTime!.valueOf()
    );
    const prevIndex = Math.max(0, currentIndex - 1);
    setState(prev => ({
      ...prev,
      selectedTime: dayjs(historicalData[prevIndex].timestamp),
      isPlaying: false,
    }));
  };

  const stepForward = () => {
    if (!state.selectedTime || historicalData.length === 0) return;

    const currentIndex = historicalData.findIndex(
      s => s.timestamp >= state.selectedTime!.valueOf()
    );
    const nextIndex = Math.min(historicalData.length - 1, currentIndex + 1);
    setState(prev => ({
      ...prev,
      selectedTime: dayjs(historicalData[nextIndex].timestamp),
      isPlaying: false,
    }));
  };

  const resetToLive = () => {
    setState({
      isActive: false,
      selectedTime: null,
      isPlaying: false,
      playbackSpeed: 1,
    });
    setHistoricalData([]);
    setCurrentSnapshot(null);
  };

  const handleSliderChange = (value: number) => {
    if (historicalData.length === 0) return;
    const index = Math.floor((value / 100) * (historicalData.length - 1));
    setState(prev => ({
      ...prev,
      selectedTime: dayjs(historicalData[index].timestamp),
      isPlaying: false,
    }));
  };

  const getSliderValue = () => {
    if (!state.selectedTime || historicalData.length === 0) return 0;
    const currentIndex = historicalData.findIndex(
      s => s.timestamp >= state.selectedTime!.valueOf()
    );
    return (currentIndex / (historicalData.length - 1)) * 100;
  };

  return (
    <UICard
      title={
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
          <HistoryOutlined />
          <span>Time Travel</span>
          {state.isActive ? (
            <UITag color="orange">Historical Mode</UITag>
          ) : (
            <UITag color="green">Live</UITag>
          )}
        </div>
      }
      extra={
        state.isActive && (
          <Button type="link" icon={<ReloadOutlined />} onClick={resetToLive}>
            Back to Live
          </Button>
        )
      }
    >
      {/* Date Selection */}
      <div style={{ marginBottom: 16 }}>
        <UIText color="secondary" style={{ display: 'block', marginBottom: 8 }}>
          Select a date to view historical metrics:
        </UIText>
        <DatePicker
          value={state.selectedTime}
          onChange={handleDateChange}
          disabledDate={date => date.isAfter(dayjs())}
          showTime={false}
          style={{ width: '100%' }}
          placeholder="Select date to time travel..."
        />
      </div>

      {state.isActive && historicalData.length > 0 && (
        <>
          {/* Current Time Display */}
          <Alert
            type="info"
            message={
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <Space>
                  <ClockCircleOutlined />
                  <UIText weight="semibold">
                    Viewing: {state.selectedTime?.format('YYYY-MM-DD HH:mm:ss')}
                  </UIText>
                </Space>
                <UIText color="secondary">
                  {dayjs().diff(state.selectedTime, 'hour')}h ago
                </UIText>
              </div>
            }
            style={{ marginBottom: 16 }}
          />

          {/* Playback Controls */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: 8,
            marginBottom: 16,
          }}>
            <Tooltip title="Step Back (5 min)">
              <Button icon={<StepBackwardOutlined />} onClick={stepBackward} />
            </Tooltip>
            <Button
              type="primary"
              shape="circle"
              size="large"
              icon={state.isPlaying ? <PauseCircleOutlined /> : <PlayCircleOutlined />}
              onClick={togglePlayback}
            />
            <Tooltip title="Step Forward (5 min)">
              <Button icon={<StepForwardOutlined />} onClick={stepForward} />
            </Tooltip>
            <div style={{ marginLeft: 16 }}>
              <UIText color="secondary" style={{ marginRight: 8 }}>Speed:</UIText>
              {[1, 2, 5, 10].map(speed => (
                <Button
                  key={speed}
                  size="small"
                  type={state.playbackSpeed === speed ? 'primary' : 'default'}
                  onClick={() => setState(prev => ({ ...prev, playbackSpeed: speed }))}
                  style={{ marginRight: 4 }}
                >
                  {speed}x
                </Button>
              ))}
            </div>
          </div>

          {/* Timeline Slider */}
          <div style={{ padding: '0 8px', marginBottom: 16 }}>
            <Slider
              value={getSliderValue()}
              onChange={handleSliderChange}
              tooltip={{
                formatter: (value) => {
                  if (!value || historicalData.length === 0) return '';
                  const index = Math.floor((value / 100) * (historicalData.length - 1));
                  return dayjs(historicalData[index].timestamp).format('HH:mm');
                },
              }}
            />
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <UIText color="secondary" style={{ fontSize: 11 }}>
                {historicalData[0] && dayjs(historicalData[0].timestamp).format('HH:mm')}
              </UIText>
              <UIText color="secondary" style={{ fontSize: 11 }}>
                {historicalData[historicalData.length - 1] &&
                  dayjs(historicalData[historicalData.length - 1].timestamp).format('HH:mm')}
              </UIText>
            </div>
          </div>

          {/* Historical Metrics */}
          {currentSnapshot && (
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(4, 1fr)',
              gap: 12,
              padding: 16,
              background: '#fafafa',
              borderRadius: 8,
            }}>
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: 20, fontWeight: 700, color: '#1890ff' }}>
                  {currentSnapshot.metrics.requests.toLocaleString()}
                </div>
                <UIText color="secondary" style={{ fontSize: 11 }}>Requests</UIText>
              </div>
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: 20, fontWeight: 700, color: '#ff4d4f' }}>
                  {currentSnapshot.metrics.errors}
                </div>
                <UIText color="secondary" style={{ fontSize: 11 }}>Errors</UIText>
              </div>
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: 20, fontWeight: 700, color: '#faad14' }}>
                  {currentSnapshot.metrics.latency}ms
                </div>
                <UIText color="secondary" style={{ fontSize: 11 }}>Latency</UIText>
              </div>
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: 20, fontWeight: 700, color: '#52c41a' }}>
                  ${currentSnapshot.metrics.cost.toFixed(2)}
                </div>
                <UIText color="secondary" style={{ fontSize: 11 }}>Cost</UIText>
              </div>
            </div>
          )}
        </>
      )}

      {!state.isActive && (
        <div style={{
          textAlign: 'center',
          padding: '40px 20px',
          color: '#999',
        }}>
          <HistoryOutlined style={{ fontSize: 48, marginBottom: 16, opacity: 0.3 }} />
          <div>Select a date above to view historical metrics</div>
          <div style={{ fontSize: 12, marginTop: 8 }}>
            You can replay system state from any point in time
          </div>
        </div>
      )}
    </UICard>
  );
}
